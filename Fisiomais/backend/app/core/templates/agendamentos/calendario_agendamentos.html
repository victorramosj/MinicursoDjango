{% extends "base.html" %}

{% block content %}
<div class="container my-2">
    <div class="card shadow">
        <div class="card-header">
            <h1 class="text-center text-primary fw-bold">
                Calendário de Agendamentos
            </h1>
        </div>


        <div class="card-body">
            <div id="calendar"></div>

        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDetalhesLabel">Detalhes do Agendamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalDetalhesBody">
                    <!-- Informações do Agendamento serão inseridas aqui via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>


                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<!-- Importar FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.css" rel="stylesheet">
{% load static %}
<link rel="stylesheet" href="{% static 'css/fullcalendar.css' %}">

{% endblock %}


{% block extra_js %}
<!-- Importar FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/locales-all.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'pt-br',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: function (info, successCallback, failureCallback) {
                fetch("{% url 'listar_agendamentos' %}")
                    .then(response => response.json())
                    .then(data => {
                        successCallback(data);
                    })
                    .catch(error => {
                        console.error("Erro ao carregar os eventos:", error);
                        failureCallback(error);
                    });
            },
            eventContent: function (arg) {
                // Personaliza o conteúdo do evento
                return {
                    html: `<div style="background-color: ${arg.event.backgroundColor}; color: ${arg.event.textColor}; padding: 2px 5px; border-radius: 3px;">
                               ${arg.event.title}
                           </div>`
                };
            },
            editable: true, // Habilita o arrastar e soltar
            droppable: true, // Permite soltar eventos
            eventClick: function (info) {
                var event = info.event;
                var modalBody = document.getElementById("modalDetalhesBody");

                modalBody.innerHTML = `
                    <p><strong>Serviço:</strong> ${event.title}</p>
                    <p><strong>Cliente:</strong> ${event.extendedProps.cliente || "Não informado"}</p>
                    <p><strong>Colaborador:</strong> ${event.extendedProps.colaborador || "Não informado"}</p>
                    <p><strong>Dia e Horário:</strong> ${new Date(event.start).toLocaleString()}</p>
                    <p><strong>Status:</strong> ${event.extendedProps.status || "Não informado"}</p>
                `;

                var editarLink = document.getElementById("editar-agendamento");
                if (editarLink) {
                    editarLink.href = `/agendamentos/editar/${event.id}/`;
                } else {
                    console.error("Elemento 'editar-agendamento' não encontrado.");
                }

                var modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
                modal.show();
            },
            eventDrop: function (info) {
                var event = info.event;

                // Obter nova data e horário
                var nova_data = event.start.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                var novo_horario = event.start.toISOString().split('T')[1].slice(0, 8); // Formato HH:MM:SS

                // Enviar dados via PUT para editar o agendamento
                fetch(`/agendamentos/editar/${event.id}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: nova_data,
                        horario: novo_horario
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Dia e horário do agendamento atualizados com sucesso.') {
                        alert('Agendamento atualizado com sucesso.');
                    } else {
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error("Erro ao atualizar o agendamento:", error);
                });
            },
            eventError: function (info) {
                console.error("Erro ao carregar evento:", info);
            }
        });

        calendar.render();
    });
</script>
{% endblock %}